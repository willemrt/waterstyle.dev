(function(e){var t=function(e){var t=(new Date).getTime(),n=Math.max(0,16-(t-lastTime)),r=setTimeout(function(){e(t+n)},n);return lastTime=t+n,r},n=e.proxy(window.requestAnimationFrame,window)||e.proxy(window.webkitRequestAnimationFrame,window)||e.proxy(window.mozRequestAnimationFrame,window)||e.proxy(window.oRequestAnimationFrame,window)||e.proxy(window.msRequestAnimationFrame,window)||t;e.fn.uparallax=function(t){var n=typeof t=="string",i=n?Array.prototype.slice.call(arguments,1):[],s;return this.each(function(){var o=e(this),u=o.data("uparallax");u?n&&(s=u.callMethod(t,i)):n?e.error("Can't call the method "+t+". The object is not initialized"):o.data("uparallax",new r(o,t))}),this.length==1&typeof s!="undefined"?s:this};var r=function(t,n){var i=this,s=e.extend({autostart:!0,element:"",effect:"scroll",movement:30,rotation:15,scaling:1.1,opacity:.5,renderer:this.getDefaultRenderer(),overflowTop:100,overflowBottom:100},n);this.opts=s,this.$parent=t.parent(),this.$element=t,this.$moveElement=typeof this.opts.element=="string"?t.find(this.opts.element):this.opts.element,r.id++,this.id=r.id,r.instances[this.id]=this,this.opts.autostart&&this.start()};r.id=0,r.instances={},r.prevTime=0,r.started=!1,r.cache={lastScrollTop:-1,scrollTop:0,winHeight:0,scrollBottom:0},r.canvas=!1,r.context=!1,r.start=function(){if(r.started)return;r.started=!0,r.draw()},r.draw=function(t){var i=r.cache.scrollTop;if(r.cache.lastScrollTop==i&&t-r.prevTime<5e3){n(r.draw);return}var s=e(window).height(),o=Math.round(i+s);r.cache.lastScrollTop=i,r.cache.winHeight=s,r.cache.scrollBottom=o;for(id in r.instances)r.instances[id].draw(t);r.prevTime=t,n(r.draw)},r.updateScroll=function(e){var t=window.pageYOffset;r.cache.scrollTop=t},e(window).one("load.upfront_paralax",r.updateScroll),e(window).on("load.upfront_paralax",r.draw),e(window).on("scroll.upfront_paralax",r.updateScroll),r.prototype={cache:{},canvas:!1,context:!1,imgCanvas:!1,imgContext:!1,callMethod:function(e,t){switch(e){case"start":this.start();break;case"stop":this.stop();break;case"destroy":this.destroy();break;case"refresh":this.refresh();break;case"setOption":this.setOption(t[0],t[1]);break;case"setEffect":this.setOption("effect",t[0]);break;case"setMovement":this.setOption("movement",t[0]);break;case"setOpacity":this.setOption("opacity",t[0]);break;case"setRotation":this.setOption("rotation",t[0]);break;case"setScaling":this.setOption("scaling",t[0])}},bindEvents:function(){e(window).on("load.upfront_parallax_"+this.id,e.proxy(this.refresh,this)),e(window).on("resize.upfront_parallax_"+this.id,e.proxy(this.refresh,this))},unbindEvents:function(){e(window).off("load.upfront_parallax_"+this.id),e(window).off("resize.upfront_parallax_"+this.id)},setOption:function(e,t){this.opts[e]=t,this.refresh()},getDefaultRenderer:function(){return"canvas"},start:function(){this.$element.addClass("upfront-parallax"),this.$moveElement.addClass("upfront-parallax-element"),this.reset_cache(),"fixed"==this.opts.renderer?this.prepareFixedPos():"canvas"==this.opts.renderer&&this.prepareCanvas(),this.refresh(),this.bindEvents(),r.start()},stop:function(){this.$element.removeClass("upfront-parallax"),this.$moveElement.removeClass("upfront-parallax-element"),"fixed"==this.opts.renderer?this.restorePos():"canvas"==this.opts.renderer&&this.removeCanvas(),this.reset(),this.unbindEvents()},reset_cache:function(){this.cache={translate:0,offsetTop:0,offsetBottom:0,offsetLeft:0,height:0,width:0,visible:!0,img:!1,imgCanvas:!1,imgContext:!1}},reset:function(){this.$moveElement.css({transform:"",opacity:"",top:"",bottom:""})},destroy:function(){this.stop(),delete r.instances[this.id],this.$element.removeData("uparallax")},prepareFixedPos:function(){this.$element.css({position:"fixed",top:0,left:0})},restorePos:function(){this.$element.css({position:"",top:"",left:"",transform:""})},prepareCanvas:function(){this.canvas===!1&&(this.canvas=document.createElement("canvas"),this.canvas.id="uparallax-"+this.id,e(this.canvas).css({position:"fixed",top:0,left:0,zIndex:-1,display:"block",pointerEvents:"none"}),e(".upfront-output-layout, .upfront-layout").append(this.canvas)),this.context=this.canvas.getContext("2d"),this.updateCanvas()},updateCanvas:function(){if(this.canvas===!1)return;this.canvas.width=e(window).width(),this.canvas.height=e(window).height()},removeCanvas:function(){e(this.canvas).remove()},prepareImage:function(){if(this.cache.img){this.imgCanvas||this.renderImage(),this.$element.css("display","none");return}var e=this,t=new Image,n=this.$moveElement.css("background-image").replace(/^url\(\s*['"]?\s*/,"").replace(/\s*['"]?\s*\)$/,"");n!="none"&&(this.cache.img=t,t.src=n,this.$element.css("display","none"))},renderImage:function(){if(!this.cache.img)return;this.imgCanvas||(this.imgCanvas=document.createElement("canvas"),e(this.imgCanvas).css({display:"block"}),this.imgContext=this.imgCanvas.getContext("2d"));var t=this.cache.width,n=this.cache.height,i=n+this.movementOffset*2,s=r.cache.winHeight,o=this.cache.img.height/this.cache.img.width,u=t,a=i,f=0,l=0,c=0,h=0,p=0;this.imgCanvas.width=t,this.imgCanvas.height=i,i/t>o?(u=i/o,l=Math.floor(t/u*this.cache.img.width)):(a=t*o,l=this.cache.img.width),f=(n-a)/2,c=Math.floor(i/a*this.cache.img.height),h=(this.cache.img.width-l)/2,p=(this.cache.img.height-c)/2,this.imgContext.drawImage(this.cache.img,h,p,l,c,0,0,t,i)},refresh:function(){this.refreshCache();var t=this.cache.height,n=e(window).height(),r=Math.round((n-t)/2);r-this.opts.movement>this.opts.movement?this.movementOffset=r-this.opts.movement:this.movementOffset=this.opts.movement,this.$moveElement.css({top:this.movementOffset*-1,bottom:this.movementOffset*-1}),"fixed"==this.opts.renderer?this.$element.css({left:this.cache.offsetLeft,height:this.cache.height,width:this.cache.width}):"canvas"==this.opts.renderer&&(this.$parent.css({background:"none"}),this.updateCanvas(),this.renderImage()),this.update()},refreshCache:function(){var e=this.$parent.offset(),t=this.$parent.height(),n=this.$parent.width();this.cache.offsetTop=e.top,this.cache.offsetBottom=e.top+t,this.cache.offsetLeft=e.left,this.cache.height=t,this.cache.width=n},update:function(){n(e.proxy(this.draw,this))},draw:function(e){if(!(this.id in r.instances))return;var t=this.cache.offsetTop,n=this.cache.offsetBottom,s=this.cache.height,o=r.cache.scrollTop,u=r.cache.scrollBottom,a=r.cache.winHeight,f=this.movementOffset*2+this.opts.movement*2,l=2*this.movementOffset,c=this.movementOffset>0?l/f:1,h=Math.round(c*(u-t-s))-this.movementOffset,p=Math.round(c*a)-this.movementOffset,d=p*-1,v=this.opts.effect.split(","),m="";if("canvas"==this.opts.renderer){this.prepareImage();if(!this.cache.img)return}n>o&&t<u?("fixed"==this.opts.renderer&&(this.cache.visible||this.$element.css("visibility","visible"),this.$element.css({transform:"translateY("+(t-o)+"px)"})),this.cache.visible=!0):this.cache.visible&&("fixed"==this.opts.renderer?this.$element.css({visibility:"hidden"}):"canvas"==this.opts.renderer&&this.clearCanvas(),this.cache.visible=!1),h>p?h=p:h<d&&(h=d);if(!this.cache.visible)return;this.cache.translate=h;if("canvas"==this.opts.renderer)this.drawCanvas(h,p);else{for(i in v){var g=this.getEffect(v[i],h,p);g.property=="transform"?(m+=m==""?"":" ",m+=g.value):this.$moveElement.css(g.property,g.value)}m!==""&&this.$moveElement.css("transform",m)}},drawCanvas:function(e,t){if(!this.cache.img||!this.imgCanvas)return;var n=this.cache.offsetTop,i=this.cache.offsetBottom,s=this.cache.offsetLeft,o=this.cache.width,u=this.cache.height,a=u+this.movementOffset*2,f=r.cache.scrollTop,l=r.cache.scrollBottom,c=r.cache.winHeight,h=u,p=this.cache.img.height/this.cache.img.width,d=o,v=a,m=0,g=0,y=0,b=0,w=0,E=0,S=0,x=this.findClosestInstances(),T=n,N=i;n<f?h=i-f:i>l&&(h=l-n),h=Math.min(c,h),E=a>u?Math.round((a-u)/2):0,n<f&&(S=f-n,E+=S),E+=e*-1,x.top&&x.top.cache.offsetBottom<n?T-=Math.min(this.opts.overflowTop,Math.ceil((n-x.top.cache.offsetBottom)/2)):x.top||(T-=this.opts.overflowTop),x.bottom&&x.bottom.cache.offsetTop>i?N+=Math.min(this.opts.overflowBottom,Math.floor((x.bottom.cache.offsetTop-i)/2)):x.bottom||(N+=this.opts.overflowBottom),this.context.drawImage(this.imgCanvas,0,0,o,a,s,n-this.movementOffset-f+e,o,a),T>f&&this.context.clearRect(s,0,o,T-f),c>N-f&&this.context.clearRect(s,N-f,o,c-(N-f))},clearCanvas:function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height)},findClosestInstances:function(){var e=!1,t=!1,n=!1;for(id in r.instances){e=r.instances[id];if(e.id==this.id)continue;if(e.cache.offsetBottom<=this.cache.offsetTop){if(t!==!1&&t.cache.offsetBottom>e.cache.offsetBottom)continue;t=e}else if(e.cache.offsetTop>=this.cache.offsetBottom){if(n!==!1&&n.cache.offsetTop<e.cache.offsetTop)continue;n=e}}return{top:t,bottom:n}},getEffect:function(e,t,n){var r="transform",i="",s=t/n;switch(e){case"scroll":i="translateY("+t+"px)";break;case"rotate":i="rotate("+s*this.opts.rotation+"deg)";break;case"scale":i="scale("+(1-(1-this.opts.scaling)*Math.abs(s))+")";break;case"opacity":r="opacity",i=1-(1-this.opts.opacity)*Math.abs(s)}return{property:r,value:i}}}})(jQuery);