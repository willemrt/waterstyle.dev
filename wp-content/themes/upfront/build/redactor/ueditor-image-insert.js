(function(e){define(["scripts/redactor/ueditor-insert","scripts/redactor/ueditor-insert-utils","scripts/redactor/ueditor-image-insert-base","text!scripts/redactor/ueditor-templates.html"],function(t,n,r,i){var s=r.ImageInsertBase.extend({className:"ueditor-insert upfront-inserted_image-wrapper upfront-inserted_image-basic-wrapper",create_controlls:function(e){this.controlsData=[{id:"link",type:"dialog",icon:"link",tooltip:"Link image",view:this.getLinkView()},{id:"toggle_caption",type:"simple",icon:"caption",tooltip:"Toggle Caption",active:_.bind(this.get_caption_state,this)}],this.allow_alignment(e)&&this.controlsData.unshift({id:"style",type:"dialog",icon:"style",tooltip:"Alignment",view:this.getStyleView()}),this.createControls()},start:function(e){var t=this,n=Upfront.Media.Manager.open({multiple_selection:!1});return n.done(function(n,r){var i=t.getImageData(r);i.id=t.data.id,t.data.clear({silent:!0}),i.style=t.defaultData.style,i.variant_id="basic-image",t.$editor=e.closest(".redactor-box"),t.data.set(i)}),n},render:function(){var t=_.extend({},this.defaultData,this.data.toJSON()),n=t.style,r=this.data.get("alignment");if(!n)return;t.style.label_id="ueditor-image-style-center",r&&(t.style.label_id="ueditor-image-style-"+r.vid,t.style.group.float=r.vid),t.image=this.get_proper_image(),t.style.group.width_cls=this.get_group_width_cls(t.image),t.show_caption==0&&(t.style.image.width_cls=Upfront.Settings.LayoutEditor.Grid.class+24);var i=this.$el.find(".ueditor-insert-variant-group"),s=Upfront.Behaviors.GridEditor,o=e(".upfront-content-marker-contents"),u=parseFloat(e(".upfront-content-marker-contents>*").css("padding-left"))/s.col_size,a=parseFloat(e(".upfront-content-marker-contents>*").css("padding-right"))/s.col_size,f=Upfront.Util.grid.width_to_col(o.width(),!0),l=f-u-a,c=e(".upfront-content-marker-contents>*").width()/l;u=u?parseInt(u):0,a=a?parseInt(a):0,n&&n.group&&n.group.float&&(n.group.float=="left"&&u>0?(t.style.group.marginLeft=(u-Math.abs(n.group.margin_left))*c,t.style.group.marginRight=0):n.group.float=="right"&&a>0?(t.style.group.marginRight=(a-Math.abs(n.group.margin_right))*c,t.style.group.marginLeft=0):n.group.float=="none"&&u>0&&(t.style.group.marginLeft=(u-Math.abs(n.group.margin_left)+Math.abs(n.group.left))*c,t.style.group.marginRight=0)),this.$el.html(this.tpl(t)),this.create_controlls(t.style.group.width_cls),this.controls.render(),this.$(".ueditor-insert-variant-group").append(this.controls.$el),this.make_caption_editable(),this.updateControlsPosition(),this.$(".ueditor-insert-variant-group").append('<a href="#" contenteditable="false" class="upfront-icon-button upfront-icon-button-delete ueditor-insert-remove"></a>')},allow_alignment:function(e){if(typeof e=="undefined")return!1;var t=parseInt(e.replace("c",""),10),n=Upfront.Util.grid.width_to_col(this.$editor.width());return t+2<=n},control_events:function(){var e=this;this.listenTo(this.controls,"control:ok:style",function(e,t){e._style&&(this.data.set("variant_id",e.variant_id),this.data.set("alignment",e._style),e.data.set("selected",e.variant_id)),t.close()})},get_group_width_cls:function(e){var t=Upfront.Util.grid.width_to_col(e.width),n=Upfront.Util.grid.width_to_col(this.$editor.width());return t+1<=n?Upfront.Settings.LayoutEditor.Grid.class+t:Upfront.Settings.LayoutEditor.Grid.class+n},get_proper_image:function(){var e=this.data.toJSON(),t=e.imageFull,n=Upfront.Settings.LayoutEditor.Grid,r=Upfront.Util.grid.width_to_col(this.$editor.width());return _.isEmpty(e.selectedImage.src)?t:e.selectedImage},importFromImage:function(t){t=t instanceof jQuery?t:e(t);var r=_.extend({},this.defaultData),i={src:t.attr("src"),width:t.width(),height:t.height()},o=e("<a>").attr("href",i.src)[0],u=this.calculateRealSize(i.src),a=t.closest(".ueditor-insert-variant-group"),f=a.attr("class"),l=a.find(".wp-caption-text"),c=l.attr("class"),h=a.find(".uinsert-image-wrapper"),p=h.attr("class"),d=1;o.origin!=window.location.origin&&(r.isLocal=0),r.imageThumb=i,r.imageFull={width:u.width,height:u.height,src:i.src};var v=t.parent();v.is("a")&&(r.linkUrl=v.attr("href"),r.linkType="external");var m=t.attr("class");m?(m=m.match(/wp-image-(\d+)/),m?r.attachmentId=m[1]:r.attachmentId=!1):r.attachmentId=!1,r.title=t.attr("title"),_.isEmpty(l.text())||(r.caption=l.html()),d=l.prev(h).length?1:0,r.show_caption=l.length,a.length?(r.style={caption:{order:1,height:l.css("minHeight")?l.css("minHeight").replace("px",""):l.height(),width_cls:Upfront.Util.grid.derive_column_class(c),left_cls:Upfront.Util.grid.derive_marginleft_class(c),top_cls:Upfront.Util.grid.derive_margintop_class(c),show:l.length},group:{"float":a.css("float"),width_cls:Upfront.Util.grid.derive_column_class(f),left_cls:Upfront.Util.grid.derive_marginleft_class(f),height:a&&a.css("minHeight")?a.css("minHeight").replace("px",""):i.height+l.height(),marginRight:0,marginLeft:0},image:{width_cls:Upfront.Util.grid.derive_column_class(p),left_cls:Upfront.Util.grid.derive_marginleft_class(p),top_cls:Upfront.Util.grid.derive_margintop_class(p),src:"",height:0}},r.variant_id=a.data("variant"),r.variant_id&&(r.alignment=n.BasicImageVariants.findWhere({vid:a.data("variant")}))):(r.alignment=n.BasicImageVariants.first(),r.variant_id=r.alignment.vid);var g=new s({data:r});g.render();var y=t.hasClass(".upfront-inserted_image-basic-wrapper")?t:t.closest(".upfront-inserted_image-basic-wrapper");return y.replaceWith(g.$el),g},getStyleView:function(){if(this.styleView)return this.styleView;var e=new n.ImageStylesView(this.data);return this.styleView=e,e}});return{ImageInsert:s}})})(jQuery);