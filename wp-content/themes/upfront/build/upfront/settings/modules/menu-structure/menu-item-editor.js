(function(e){define(["text!scripts/upfront/settings/modules/menu-structure/menu-item-editor.tpl"],function(t){var n=function(){var e=[],t=Upfront.Application.layout.get("regions");return _.each(t.models,function(t){t.attributes.sub=="lightbox"&&e.push({id:"#"+t.get("name"),label:t.get("title")})}),e},r=function(){var e=Upfront.Application.layout.get("regions"),t=[],n;return n=function(e){e.each(function(e){var r=e.get_property_value_by_name("anchor");r&&r.length&&t.push({id:"#"+r,label:r}),e.get("objects")?e.get("objects").each(function(e){var n=e.get_property_value_by_name("anchor");n&&n.length&&t.push({id:"#"+n,label:n})}):e.get("modules")&&n(e.get("modules"))})},e.each(function(e){n(e.get("modules"))}),t},i=function(){var e=[];return _.each(Upfront.data.ugallery.postTypes,function(t){t.name!="attachment"&&e.push({name:t.name,label:t.label})}),e},s=Backbone.View.extend({className:"menu-item-editor",events:{"click .menu-item-entry-input":"showPagePostSelector","keydown .menu-item-lightbox-input":"onLightboxNameInputChange","keydown .menu-item-external-input":"onUrlNameKeydown","change .menu-item-external-input":"onUrlNameChange","keydown .menu-item-email-input":"onEmailNameKeydown","change .menu-item-email-input":"onEmailNameChange","keydown .menu-item-title":"onItemNameKeydown","change .menu-item-title":"onItemNameChange"},initialize:function(e){this.options=e||{},this.type=Upfront.Util.guessLinkType(this.model.get("menu-item-url"))},render:function(){return this.$el.html(_.template(t,{title:this.model.get("menu-item-title"),type:this.type,lightboxes:n(),url:this.model.get("menu-item-url")})),this.renderTypeSelect(),this.type==="anchor"&&this.renderAnchorSelect(),this.type==="lightbox"&&n()&&this.renderLightBoxesSelect(),this.type!=="anchor"&&this.type!=="anchor"&&this.renderLinkTargetSelect(),this},renderTypeSelect:function(){var e=this,t=[];_.each(["unlink","external","entry","anchor","lightbox","email"],function(e){t.push(this.getLinkTypeValue(e))},this),this.typeSelect=new Upfront.Views.Editor.Field.Select({label:"",values:t,default_value:this.type||"external",change:function(t){e.onTypeChange(t)}}),this.typeSelect.render(),this.$el.find(".item-links-to-label").after(this.typeSelect.el)},renderLinkTargetSelect:function(){var e=this,t=new Upfront.Views.Editor.Field.Select({label:"",values:[{value:"",label:"Same Browser Tab"},{value:"_blank",label:"New Browser Tab"}],default_value:this.model.get("menu-item-target"),change:function(t){e.onTargetChange(t)}});t.render(),this.$el.find(".menu-item-target-label").after(t.el)},getLinkTypeValue:function(e){var t=Upfront.Settings.l10n.global.content;switch(e){case"unlink":return{value:"unlink",label:t.no_link};case"external":return{value:"external",label:t.url};case"email":return{value:"email",label:t.email_address};case"entry":return{value:"entry",label:t.post_or_page};case"anchor":return{value:"anchor",label:t.anchor};case"image":return{value:"image",label:t.larger_image};case"lightbox":return{value:"lightbox",label:t.lightbox}}},showPagePostSelector:function(e){e&&e.preventDefault();var t=this,n={postTypes:i()};Upfront.Views.Editor.PostSelector.open(n).done(function(e){t.model.set({"menu-item-url":e.get("permalink")}),t.saveItem(),t.render()})},saveItem:function(){var e=this;Upfront.Util.post({action:"upfront_update_single_menu_item",menuId:this.options.menuId,menuItemData:this.model.toJSON()}).done(function(){e.trigger("change")})},onTypeChange:function(e){this.model.set({"menu-item-url":""}),this.type=e,this.render(),this.type==="entry"?this.showPagePostSelector():this.type==="unlink"&&this.saveItem(),this.$el.parent().find(".menu-item-type").first().text(this.getLinkTypeLabel(e))},onTargetChange:function(e){this.model.set({"menu-item-target":e}),this.saveItem()},renderAnchorSelect:function(){var e=this,t=[{label:"Choose Anchor...",value:""}];_.each(r(),function(e){t.push({label:e.label,value:e.id})});var n=this.model.get("menu-item-url");n=n?n:"",n=n.match(/^#/)?n:"",this.anchorSelect=new Upfront.Views.Editor.Field.Select({label:"",values:t,default_value:n,change:function(){e.model.set({"menu-item-url":this.get_value()}),e.saveItem()}}),this.anchorSelect.render(),this.$el.find(".anchor-selector").append(this.anchorSelect.el)},renderLightBoxesSelect:function(){var e=this,t=[{label:"Choose Lightbox...",value:""}];_.each(n()||[],function(e){t.push({label:e.label,value:e.id})});var r=this.model.get("menu-item-url");r=r?r:"",r=r.match(/^#/)?r:"",this.lightboxSelect=new Upfront.Views.Editor.Field.Select({label:"",values:t,default_value:r,change:function(){e.model.set({"menu-item-url":this.get_value()}),e.saveItem()}}),this.lightboxSelect.render(),this.$el.find(".lightbox-selector").append(this.lightboxSelect.el)},onLightboxNameInputChange:function(e){e.which==13&&(e.preventDefault(),this.createLightBox())},createLightBox:function(){var t=e.trim(this.$(".menu-item-lightbox-input").val());if(!t)return Upfront.Views.Editor.notify(l10n.ltbox_empty_name_nag,"error"),!1;this.model.set({"menu-item-url":"#"+Upfront.Application.LayoutEditor.createLightboxRegion(t)}),this.saveItem(),this.render()},onUrlNameKeydown:function(e){e.which==13&&(e.preventDefault(),this.onUrlNameChange())},onUrlNameChange:function(){this.model.set({"menu-item-url":e.trim(this.$el.find(".menu-item-external-input").val())}),this.saveItem()},onEmailNameKeydown:function(e){e.which==13&&(e.preventDefault(),this.onEmailNameChange())},onEmailNameChange:function(){this.model.set({"menu-item-url":"mailto:"+e.trim(this.$el.find(".menu-item-email-input").val())}),this.saveItem()},onItemNameKeydown:function(e){e.which==13&&(e.preventDefault(),this.onItemNameChange())},onItemNameChange:function(){var t=e.trim(this.$el.find(".menu-item-title").val());this.model.set({"menu-item-title":t}),this.$el.parent().find(".menu-item-title").first().text(t),this.saveItem()},getLinkTypeLabel:function(e){var t=Upfront.Settings.l10n.global.content;switch(e){case"unlink":return t.no_link;case"external":return t.url;case"email":return t.email_address;case"entry":return t.post_or_page;case"anchor":return t.anchor;case"image":return t.larger_image;case"lightbox":return t.lightbox}}});return s})})(jQuery);