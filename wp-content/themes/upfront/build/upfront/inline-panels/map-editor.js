(function($){var l10n=Upfront.Settings&&Upfront.Settings.l10n?Upfront.Settings.l10n.global.views:Upfront.mainData.l10n.global.views;define(["text!scripts/upfront/templates/map-editor.html"],function(editorTpl){var MapEditorView=Upfront.Views.ObjectView.extend({is_editing:!1,script_error:!1,SYNTAX_TYPES:{script:"json"},MIN_HEIGHT:200,editorTpl:_.template(editorTpl),content_editable_selector:".editable",initialize:function(){var e=this.fallback("script");this.checkJSon(e)},on_render:function(){this.start_json_editor()},start_json_editor:function(){if(this.is_editing)return!1;this.is_editing=!0;var e=$("#upfront_map-editor"),t=this;e.length||(e=$('<section id="upfront_map-editor" class="upfront-ui upfront_map-editor upfront_map-editor-complex"></section>'),$("body").append(e)),require([Upfront.Settings.ace_url],function(){t.createEditor(e)})},on_edit:function(){if(this.is_editing)return!1;var e=this.$el.find(".upfront_map-element "+this.content_editable_selector);if(e.length)return this.bootContentEditors(e);this.is_editing=!0;var t=$("#upfront_map-editor");t.length||(t=$('<section id="upfront_map-editor" class="upfront-ui upfront_map-editor upfront_map-editor-complex"></section>'),$("body").append(t)),this.createEditor(t)},bootContentEditors:function(e){if(!e||!e.length)return!1;var t=$(this.fallback("markup")),n=this;e.each(function(e){var r=$(this),i=e<=0;if(r.data("ueditor"))return!0;r.ueditor({autostart:i,placeholder:"",disableLineBreak:!0}).on("start",function(){n.is_editing=!0}).on("stop",function(){n.is_editing=!1}).on("syncAfter",function(){var i=$(t.find(n.content_editable_selector)[e]);if(!i.length)return!1;i.html(r.html()),n.property("markup",$("<div />").append(t).html())})})},startResizable:function(e){var t=this,n=e.find(".upfront-css-body"),r=0,i=e.find(".upfront_map-editor-complex-wrapper"),s=function(s,o){var u=o?o.size.height:e.find(".upfront_map-editor-complex-wrapper").height(),a=u-r;n.height(a),_.each(t.editors,function(e){e.resize()}),i.css({width:"",height:"",left:"",top:""})};i.find(".upfront-css-top").removeClass("ui-resizable-handle").addClass("ui-resizable-handle").removeClass("ui-resizable-n").addClass("ui-resizable-n"),r=e.find(".upfront-css-top").outerHeight(),s(),i.resizable({handles:{n:".upfront-css-top"},resize:s,minHeight:200,delay:100})},createEditor:function(e){var t=this;e.html(this.editorTpl({markup:this.fallback("markup"),style:this.fallback("style"),script:this.fallback("script"),l10n:l10n.template})),$("#page").css("padding-bottom","200px"),e.show(),this.resizeHandler=this.resizeHandler||function(){e.width($(window).width()-$("#sidebar-ui").width()-1)},$(window).on("resize",this.resizeHandler),this.resizeHandler(),this.editors={},this.timers={},e.find(".upfront_map-ace").each(function(){var n=$(this),r=n.html(),i=ace.edit(this),s=n.data("type");i.getSession().setUseWorker(!1),i.setTheme("ace/theme/monokai"),i.getSession().setMode("ace/mode/"+t.SYNTAX_TYPES[s]),i.setShowPrintMargin(!1),"markup"===s&&r&&i.getSession().setValue(r),i.on("change",function(){t.timers[s]&&clearTimeout(t.timers[s]),t.timers[s]=setTimeout(function(){var n=i.getValue();s=="script"&&t.checkJSon(n),t.script_error?e.find(".upfront_map-jsalert").show().find("i").attr("title",l10n.create.js_error+" "+t.script_error):e.find(".upfront_map-jsalert").hide(),t.property(s,n,!1)},1e3)}),i.renderer.scrollBar.width=5,i.renderer.scroller.style.right="5px",t.editors[s]=i}),this.currentEditor=this.editors.markup;var n=e.find(".upfront-css-top"),r=e.find(".upfront-css-body");r.height(this.MIN_HEIGHT-n.outerHeight()),this.startResizable(e),e.find("button").on("click",function(e){_.each(t.editors,function(e,n){t.property(n,e.getValue())}),t.property("map_styles",t.fallback("script"),!1),t.is_editing=!1,t.destroyEditor()}),e.on("click",".upfront-css-type",function(e){t.hiliteElement(e)}).on("click",".upfront-css-close",function(e){e.preventDefault(),t.destroyEditor(),$("#page").css("padding-bottom",0)})},destroyEditor:function(){var e=this;this.editors&&this.editors.length&&(_.each(this.editors,function(e){e.destroy()}),e.editors=!1),this.currentEditor=!1,$("#upfront_map-editor").html("").hide(),$(window).off("resize",this.resizeHandler),this.is_editing=!1},hiliteElement:function(e){e.preventDefault();var t=this.$el.find(".upfront-object-content"),n=t.offset().top-50;$(document).scrollTop(n>0?n:0),this.blink(t,4)},blink:function(e,t){var n=this;e.css("outline","3px solid #3ea"),setTimeout(function(){e.css("outline","none"),t--,t>0&&setTimeout(function(){n.blink(e,t-1)},100)},100)},checkJSon:function(json){this.script_error=!1;try{eval(json)}catch(e){this.script_error=e.message}},fallback:function(e){return this.model.get_property_value_by_name(e)||Upfront.data.upfront_code.defaults.fallbacks[e]},property:function(e,t,n){return typeof t!="undefined"?(typeof n=="undefined"&&(n=!0),this.model.set_property(e,t,n)):this.model.get_property_value_by_name(e)}});return MapEditorView})})(jQuery);